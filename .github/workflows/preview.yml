name: Preview

on:
  workflow_dispatch:

  pull_request:
    types: [opened, reopened]

jobs:
  preview:
    runs-on: ubuntu-latest
    steps:
      # - name: Checkout branch
      #   uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.1"

      - name: Install Forge Previewer
        run: composer global require ryangjchandler/forge-previewer

      - name: Deploy preview environment
        run: forge-previewer deploy --token=${{ secrets.FORGE_TOKEN }} --server=${{ secrets.FORGE_PREVIEW_SERVER }} --repo=${{ github.repository }} --branch=${{ github.head_ref }} --domain=${{ secrets.FORGE_PREVIEW_DOMAIN }}

      # @TODO: Do we need to pull output directly from forge-previewer ?
      - name: Set Test Output
        id: deploy
        run: |
          echo "::set-output name=domain::https://${{ github.head_ref }}.${{ secrets.FORGE_PREVIEW_DOMAIN }}/"

      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: |
            Hello world ! :wave: ${{ steps.deploy.outputs.domain }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
